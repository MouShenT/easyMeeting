var Ge=Object.defineProperty;var Pe=(R,s,o)=>s in R?Ge(R,s,{enumerable:!0,configurable:!0,writable:!0,value:o}):R[s]=o;var A=(R,s,o)=>Pe(R,typeof s!="symbol"?s+"":s,o);import{W as m,X as v,ad as H,d as ye,y as oe,c as T,v as D,F as re,z as ce,b as r,t as M,g as C,ae as se,s as U,w as h,e as c,H as _e,f as B,af as de,D as we,h as X,o as f,u as je,r as S,a9 as Ke,a as Se,Y as Xe,n as qe,E as y,k as Je,I as Ye,G as Qe,B as G,ag as le,ah as Ze,P as ne,ai as et,aj as tt,ak as Ie,al as nt,C as ot,am as st,an as at,i as it,J as lt,a3 as rt,a5 as ct,aa as dt,ao as ut,$ as gt,ap as ft,aq as mt,ar as ht,as as vt,at as pt,au as Ct,av as wt}from"./index-VWzLSCGP.js";import{b as St,l as It}from"./contact-CKvSw65A.js";import{_ as Te}from"./_plugin-vue_export-helper-DlAUqK2U.js";const yt={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"}],iceCandidatePoolSize:10,bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"};class _t{constructor(){A(this,"peerConnections",new Map);A(this,"localStream",null);A(this,"meetingId","");A(this,"userId","");A(this,"initialized",!1);A(this,"onRemoteStream",null);A(this,"onStreamRemoved",null);A(this,"boundHandleOffer");A(this,"boundHandleAnswer");A(this,"boundHandleIceCandidate");this.boundHandleOffer=this.handleOffer.bind(this),this.boundHandleAnswer=this.handleAnswer.bind(this),this.boundHandleIceCandidate=this.handleIceCandidate.bind(this)}init(s,o,n,i){this.initialized&&this.cleanup(),this.meetingId=s,this.userId=o,this.onRemoteStream=n,this.onStreamRemoved=i,this.initialized=!0,m.on(v.WEBRTC_OFFER,this.boundHandleOffer),m.on(v.WEBRTC_ANSWER,this.boundHandleAnswer),m.on(v.WEBRTC_ICE_CANDIDATE,this.boundHandleIceCandidate),console.log("WebRTCManager initialized for meeting:",s,"user:",o)}async initLocalMedia(s=!0,o=!0){try{if(!window.isSecureContext)throw console.error("getUserMedia requires a secure context (HTTPS or localhost)"),new Error("需要 HTTPS 或 localhost 环境才能访问摄像头/麦克风");if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw console.error("getUserMedia is not supported in this browser"),new Error("当前浏览器不支持摄像头/麦克风访问");const n={video:s?{width:{min:320,ideal:640,max:1280},height:{min:240,ideal:480,max:720},frameRate:{min:10,ideal:24,max:30},facingMode:"user"}:!1,audio:o?{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:{ideal:44100},channelCount:{ideal:1}}:!1};return console.log("Requesting media with constraints:",JSON.stringify(n)),this.localStream=await navigator.mediaDevices.getUserMedia(n),console.log("Got local stream with tracks:",this.localStream.getTracks().map(i=>`${i.kind}:${i.label}`)),this.localStream}catch(n){if(console.error("Failed to get local media:",n),s){if(n.name==="OverconstrainedError"||n.name==="NotReadableError"){console.log("Trying lower resolution...");try{return this.localStream=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:320},height:{ideal:240},frameRate:{ideal:15}},audio:o?{echoCancellation:!0,noiseSuppression:!0}:!1}),console.log("Got low-res stream"),this.localStream}catch(i){console.error("Low-res also failed:",i)}}console.log("Video failed, trying audio only...");try{return this.localStream=await navigator.mediaDevices.getUserMedia({video:!1,audio:o?{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}:!1}),console.log("Got audio-only stream"),this.localStream}catch(i){console.error("Failed to get audio-only stream:",i)}}return n.name==="NotAllowedError"||n.name==="PermissionDeniedError"?console.error("用户拒绝了摄像头/麦克风权限"):n.name==="NotFoundError"||n.name==="DevicesNotFoundError"?console.error("未找到摄像头或麦克风设备"):n.name==="NotReadableError"||n.name==="TrackStartError"?console.error("摄像头或麦克风被其他程序占用"):n.name==="OverconstrainedError"?console.error("请求的媒体约束无法满足"):n.name==="TypeError"&&console.error("媒体约束配置错误"),null}}getLocalStream(){return this.localStream}createConnection(s){console.log("Creating PeerConnection for:",s,"hasLocalStream:",!!this.localStream);const o=this.peerConnections.get(s);if(o){const i=o.connectionState;if(i==="connecting"||i==="connected"||i==="new")return console.log("Reusing existing connection with:",s,"state:",i),o;console.log("Closing stale connection with:",s,"state:",i),this.closeConnection(s)}const n=new RTCPeerConnection(yt);if(this.peerConnections.set(s,n),this.localStream){const i=this.localStream.getTracks();console.log("Adding local tracks to PeerConnection, tracks:",i.length),i.forEach(u=>{const _=n.addTrack(u,this.localStream);console.log("Added track:",u.kind,"enabled:",u.enabled,"readyState:",u.readyState),u.kind==="video"&&_&&this.optimizeVideoEncoding(_)})}else console.warn("No local stream available when creating connection - will only receive remote video"),n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"}),console.log("Added recvonly transceivers for video and audio");return n.onicecandidate=i=>{i.candidate&&m.send({messageSendToType:H.USER,meetingId:this.meetingId,messageType:v.WEBRTC_ICE_CANDIDATE,sendUserId:this.userId,receiveUserId:s,messageContent:i.candidate})},n.ontrack=i=>{if(console.log("=== Received remote track ==="),console.log("From:",s),console.log("Track kind:",i.track.kind),console.log("Track enabled:",i.track.enabled),console.log("Track readyState:",i.track.readyState),console.log("Streams count:",i.streams.length),i.streams&&i.streams[0]){const u=i.streams[0];console.log("Stream id:",u.id),console.log("Stream tracks:",u.getTracks().map(_=>`${_.kind}:${_.enabled}`)),this.onRemoteStream?(console.log("Calling onRemoteStream callback for:",s),this.onRemoteStream(s,u)):console.error("onRemoteStream callback is not set!")}else console.warn("No stream in track event")},n.onconnectionstatechange=()=>{console.log(`PeerConnection state with ${s}:`,n.connectionState),n.connectionState==="connected"?console.log(`Successfully connected to ${s}`):n.connectionState==="failed"?(console.error(`Connection with ${s} failed, attempting to restart ICE`),n.restartIce()):n.connectionState==="disconnected"&&console.warn(`Connection with ${s} disconnected`)},n.oniceconnectionstatechange=()=>{console.log(`ICE connection state with ${s}:`,n.iceConnectionState),n.iceConnectionState==="failed"&&console.error(`ICE connection failed with ${s}`)},n}async optimizeVideoEncoding(s){try{const o=s.getParameters();(!o.encodings||o.encodings.length===0)&&(o.encodings=[{}]),o.encodings[0].maxBitrate=5e5,o.encodings[0].maxFramerate=24,o.encodings[0].priority="high",o.encodings[0].networkPriority="high",await s.setParameters(o),console.log("Video encoding optimized")}catch(o){console.warn("Failed to optimize video encoding:",o)}}async initiateConnection(s){if(console.log("Initiating connection to:",s,"hasLocalStream:",!!this.localStream),!this.localStream){console.log("Waiting for local stream before initiating connection...");let i=0;const u=3e3,_=100;for(;!this.localStream&&i<u;)await new Promise(E=>setTimeout(E,_)),i+=_;this.localStream?console.log("Local stream ready after",i,"ms"):console.warn("Local stream not ready after",u,"ms, proceeding with recvonly connection")}const o=this.peerConnections.get(s);if(o){const i=o.connectionState;if(i==="connected"){console.log("Already connected to:",s,"- skipping");return}if(i==="connecting"){console.log("Already connecting to:",s,"- skipping");return}}const n=this.createConnection(s);try{const i=await n.createOffer();await n.setLocalDescription(i);const u=this.localStream?this.localStream.getTracks().length>0:!1;console.log("Sending offer to:",s,"hasLocalTracks:",u),m.send({messageSendToType:H.USER,meetingId:this.meetingId,messageType:v.WEBRTC_OFFER,sendUserId:this.userId,receiveUserId:s,messageContent:i})}catch(i){console.error("Failed to create offer:",i)}}async handleOffer(s){var E;const o=s.sendUserId,i=(((E=s.messageContent)==null?void 0:E.sdp)||"").includes("a=recvonly");if(console.log("Received offer from:",o,"hasLocalStream:",!!this.localStream,"isRecvOnlyOffer:",i),!this.localStream){console.log("Local stream not ready, waiting...");let w=0;const I=5e3,p=100;for(;!this.localStream&&w<I;)await new Promise(b=>setTimeout(b,p)),w+=p;const g=this.localStream;g?console.log("Local stream ready after",w,"ms, tracks:",g.getTracks().length):console.warn("Local stream still not ready after",I,"ms, proceeding without it")}const u=this.peerConnections.get(o);if(u){const w=u.connectionState;if(w==="connected"){console.log("Received offer on existing connected connection, handling renegotiation");try{await u.setRemoteDescription(new RTCSessionDescription(s.messageContent));const I=await u.createAnswer();await u.setLocalDescription(I),console.log("Sending renegotiation answer to:",o),m.send({messageSendToType:H.USER,meetingId:this.meetingId,messageType:v.WEBRTC_ANSWER,sendUserId:this.userId,receiveUserId:o,messageContent:I})}catch(I){console.error("Failed to handle renegotiation offer:",I)}return}if(w==="connecting"||w==="new"){if(this.userId<o){console.log("Glare detected, my userId is smaller, ignoring offer from:",o);return}console.log("Glare detected, my userId is larger, accepting offer from:",o),this.closeConnection(o)}}const _=this.createConnection(o);try{await _.setRemoteDescription(new RTCSessionDescription(s.messageContent));const w=await _.createAnswer();await _.setLocalDescription(w),console.log("Sending answer to:",o),m.send({messageSendToType:H.USER,meetingId:this.meetingId,messageType:v.WEBRTC_ANSWER,sendUserId:this.userId,receiveUserId:o,messageContent:w}),i&&this.localStream?(console.log("Received recvonly offer, will initiate reverse connection to send our video"),setTimeout(()=>{this.renegotiateConnection(o)},1500)):this.localStream&&_.getSenders().filter(I=>I.track!==null).length===0&&(console.log("Local stream ready but no senders, triggering renegotiation with:",o),setTimeout(()=>{this.renegotiateConnection(o)},1e3))}catch(w){console.error("Failed to handle offer:",w)}}async renegotiateConnection(s){const o=this.peerConnections.get(s);if(!o||!this.localStream)return;if(o.connectionState!=="connected"&&o.connectionState!=="connecting"){console.log("Connection not ready for renegotiation:",o.connectionState);return}if(o.getSenders().filter(i=>i.track!==null).length>0){console.log("Already have senders, no need to renegotiate");return}console.log("Renegotiating connection with:",s,"to add local tracks");try{this.localStream.getTracks().forEach(u=>{o.addTrack(u,this.localStream),console.log("Added track for renegotiation:",u.kind)});const i=await o.createOffer();await o.setLocalDescription(i),console.log("Sending renegotiation offer to:",s),m.send({messageSendToType:H.USER,meetingId:this.meetingId,messageType:v.WEBRTC_OFFER,sendUserId:this.userId,receiveUserId:s,messageContent:i})}catch(i){console.error("Failed to renegotiate connection:",i)}}async handleAnswer(s){const o=s.sendUserId;console.log("Received answer from:",o);const n=this.peerConnections.get(o);if(n)try{await n.setRemoteDescription(new RTCSessionDescription(s.messageContent))}catch(i){console.error("Failed to set remote description:",i)}}async handleIceCandidate(s){const o=s.sendUserId;console.log("Received ICE candidate from:",o);const n=this.peerConnections.get(o);if(n)try{await n.addIceCandidate(new RTCIceCandidate(s.messageContent))}catch(i){console.error("Failed to add ICE candidate:",i)}}closeConnection(s){const o=this.peerConnections.get(s);o&&(o.close(),this.peerConnections.delete(s),console.log("Closed connection with:",s),this.onStreamRemoved&&this.onStreamRemoved(s))}closeAllConnections(){console.log("Closing all peer connections, count:",this.peerConnections.size),this.peerConnections.forEach((s,o)=>{s.close(),this.onStreamRemoved&&this.onStreamRemoved(o)}),this.peerConnections.clear()}stopLocalMedia(){this.localStream&&(console.log("Stopping local media tracks"),this.localStream.getTracks().forEach(s=>{s.stop()}),this.localStream=null)}toggleVideo(s){this.localStream&&this.localStream.getVideoTracks().forEach(o=>{o.enabled=s})}toggleAudio(s){this.localStream&&this.localStream.getAudioTracks().forEach(o=>{o.enabled=s})}cleanup(){console.log("WebRTCManager cleanup"),this.closeAllConnections(),this.stopLocalMedia(),this.initialized&&(m.off(v.WEBRTC_OFFER,this.boundHandleOffer),m.off(v.WEBRTC_ANSWER,this.boundHandleAnswer),m.off(v.WEBRTC_ICE_CANDIDATE,this.boundHandleIceCandidate),this.initialized=!1),this.meetingId="",this.userId="",this.onRemoteStream=null,this.onStreamRemoved=null}hasConnection(s){return this.peerConnections.has(s)}getConnectionCount(){return this.peerConnections.size}}const k=new _t,Tt={class:"member-list"},kt={class:"member-avatar"},Et={class:"member-detail"},Mt={class:"name"},Rt={key:0,class:"host-tag"},bt={key:1,class:"self-tag"},Nt={class:"member-status"},Ot={key:0,class:"member-actions"},xt={key:0,class:"empty-tip"},At=ye({__name:"MemberList",props:{members:{},currentUserId:{},creatorId:{}},emits:["kick","blacklist"],setup(R,{emit:s}){const o=R,n=s,i=oe(()=>o.currentUserId===o.creatorId);function u(E){n("kick",E)}function _(E){n("blacklist",E)}return(E,w)=>{const I=B("el-icon"),p=B("el-button");return f(),T("div",Tt,[(f(!0),T(re,null,ce(R.members,g=>(f(),T("div",{key:g.userId,class:"member-item"},[r("div",kt,M(g.nickName.charAt(0)),1),r("div",Et,[r("span",Mt,M(g.nickName),1),g.memberType===C(se).CREATOR?(f(),T("span",Rt,"主持人")):D("",!0),g.userId===R.currentUserId?(f(),T("span",bt,"我")):D("",!0)]),r("div",Nt,[g.videoOpen?(f(),U(I,{key:0,class:"status-on"},{default:h(()=>[c(C(_e))]),_:1})):(f(),U(I,{key:1,class:"status-off"},{default:h(()=>[c(C(de))]),_:1}))]),i.value&&g.userId!==R.currentUserId&&g.memberType!==C(se).CREATOR?(f(),T("div",Ot,[c(p,{type:"warning",size:"small",text:"",onClick:we(b=>u(g.userId),["stop"])},{default:h(()=>[...w[0]||(w[0]=[X(" 踢出 ",-1)])]),_:1},8,["onClick"]),c(p,{type:"danger",size:"small",text:"",onClick:we(b=>_(g.userId),["stop"])},{default:h(()=>[...w[1]||(w[1]=[X(" 拉黑 ",-1)])]),_:1},8,["onClick"])])):D("",!0)]))),128)),R.members.length===0?(f(),T("div",xt," 暂无成员 ")):D("",!0)])}}}),Lt=Te(At,[["__scopeId","data-v-841d511a"]]),Ut={class:"meeting-container"},Dt={class:"meeting-header"},$t={class:"header-left"},Vt={class:"meeting-info"},Bt={class:"meeting-name"},Ht={class:"meeting-id"},Ft={class:"meeting-time"},zt={class:"video-area"},Wt=["muted"],Gt={key:1,class:"video-placeholder"},Pt={class:"avatar"},jt={class:"member-info"},Kt={class:"member-name"},Xt={class:"meeting-controls"},qt={class:"invite-dialog"},Jt={class:"contact-list"},Yt=["onClick"],Qt={class:"contact-avatar"},Zt={class:"contact-info"},en={class:"contact-name"},tn={key:0,class:"selected-count"},nn=ye({__name:"Meeting",setup(R){const s=Ke(),o=Je(),n=je(),i=S(s.params.meetingId||""),u=S(""),_=S("视频会议"),E=S(""),w=S(0);let I=null;const p=S([]),g=Se({}),b=Se({});function ke(e){return!!g[e]}const N=S(!0),L=S(!0),q=S(!1),J=S(!1),F=S(!1),ae=S([]),Y=S(!1),x=S([]),P=S(""),ie=S(!1),ue=oe(()=>{if(!P.value)return ae.value;const e=P.value.toLowerCase();return ae.value.filter(t=>t.contactNickName.toLowerCase().includes(e))});Xe(F,async e=>{if(e){x.value=[],P.value="",Y.value=!0;try{ae.value=await It()}catch(t){console.error("加载联系人失败:",t),y.error("加载联系人失败")}finally{Y.value=!1}}});function Ee(e){const t=x.value.indexOf(e);t===-1?x.value.push(e):x.value.splice(t,1)}async function Me(){if(x.value.length===0){y.warning("请选择要邀请的联系人");return}ie.value=!0;try{await ht(x.value),y.success(`已向 ${x.value.length} 位联系人发送邀请`),F.value=!1}catch(e){console.error("发送邀请失败:",e),y.error(e.message||"发送邀请失败")}finally{ie.value=!1}}const $=S([]),V=S(!1),z=S(!0),Q=S(null),Re=oe(()=>n.userId===E.value),be=oe(()=>{const e=p.value.length;return e<=1?"grid-1":e<=2?"grid-2":e<=4?"grid-4":e<=6?"grid-6":"grid-9"});function Ne(e,t){if(t){b[e]=t;const l=g[e];if(l)t.srcObject=l;else if(e===n.userId){const d=k.getLocalStream();d&&(g[e]=d,t.srcObject=d)}}}function Oe(e){const t=Math.floor(e/3600),l=Math.floor(e%3600/60),d=e%60;return t>0?`${t.toString().padStart(2,"0")}:${l.toString().padStart(2,"0")}:${d.toString().padStart(2,"0")}`:`${l.toString().padStart(2,"0")}:${d.toString().padStart(2,"0")}`}function xe(){o.push("/")}async function Ae(){try{const e=await k.initLocalMedia(N.value,L.value);e?(g[n.userId]=e,await le(),b[n.userId]&&(b[n.userId].srcObject=e)):(y.warning("无法获取摄像头/麦克风权限，请检查浏览器设置"),N.value=!1,L.value=!1)}catch(e){console.error("初始化媒体失败:",e),window.isSecureContext?e.name==="NotAllowedError"?y.warning("您拒绝了摄像头/麦克风权限，请在浏览器设置中允许"):e.name==="NotFoundError"?y.warning("未检测到摄像头或麦克风设备"):e.name==="NotReadableError"?y.warning("摄像头或麦克风被其他程序占用"):y.warning("无法获取摄像头/麦克风权限"):y.error("请使用 HTTPS 或 localhost 访问，否则无法使用摄像头"),N.value=!1,L.value=!1}}function Le(){N.value=!N.value,k.toggleVideo(N.value);const e=p.value.find(t=>t.userId===n.userId);e&&(e.videoOpen=N.value),m.send({messageSendToType:H.GROUP,meetingId:i.value,messageType:v.MEETING_USER_VIDEO_CHANGE,sendUserId:n.userId,messageContent:{videoOpen:N.value}})}function Ue(){L.value=!L.value,k.toggleAudio(L.value)}async function De(e,t){const l=t||"0",d=t?1:0;$.value.push({sendUserId:n.userId,sendUserNickName:n.nickName,content:e,messageContent:e,sendTime:Date.now(),receiveType:d,receiveUserId:l});try{await vt(e,v.CHAT_TEXT_MESSAGE,l)}catch(O){console.error("发送消息失败:",O)}}async function ge(){if(console.log("loadChatHistory 被调用, chatLoading:",V.value),V.value){console.log("chatLoading 为 true，跳过加载");return}V.value=!0;try{console.log("开始调用 loadMeetingMessages API...");const e=await Ze(1,20);console.log("loadMeetingMessages 返回结果:",e),e.list&&e.list.length>0?($.value=e.list.map(fe).reverse(),Q.value=Math.min(...e.list.map(t=>t.messageId)),z.value=e.list.length>=20,console.log("聊天消息已加载，数量:",$.value.length)):(z.value=!1,console.log("没有聊天消息"))}catch(e){console.error("加载聊天历史失败:",e)}finally{V.value=!1}}async function $e(){if(!(V.value||!z.value||!Q.value)){V.value=!0;try{const e=await pt(Q.value,20);if(e.list&&e.list.length>0){const t=e.list.map(fe).reverse();$.value=[...t,...$.value],Q.value=Math.min(...e.list.map(l=>l.messageId)),z.value=e.list.length>=20}else z.value=!1}catch(e){console.error("加载更多消息失败:",e)}finally{V.value=!1}}}function fe(e){return{messageId:e.messageId,sendUserId:e.sendUserId,sendUserNickName:e.sendUserNickName,content:e.messageContent,messageContent:e.messageContent,sendTime:e.sendTime,receiveType:e.receiveType,receiveUserId:e.receiveUserId}}async function Ve(e){try{await ne.confirm("确定要踢出该成员吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Ct(e),y.success("已踢出该成员")}catch(t){t!=="cancel"&&console.error("踢出成员失败:",t)}}async function Be(e){try{await ne.confirm("确定要拉黑该成员吗？拉黑后该成员将无法重新加入会议。","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await wt(e),y.success("已拉黑该成员")}catch(t){t!=="cancel"&&console.error("拉黑成员失败:",t)}}async function He(){try{await ne.confirm("确定要结束会议吗？所有成员都将被移出会议。","结束会议",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await et()}catch(e){e!=="cancel"&&console.error("结束会议失败:",e)}}async function Fe(){try{const e=p.value.length<=1,t=n.userId===E.value;let l="确定要离开会议吗？",d="离开会议";e?(l="您是会议中的最后一个成员，离开后会议将自动结束。确定要离开吗？",d="离开并结束会议"):t&&(l='您是会议主持人，离开后会议仍将继续。如需结束会议请点击"结束会议"按钮。确定要离开吗？'),await ne.confirm(l,d,{confirmButtonText:"确定",cancelButtonText:"取消",type:e?"warning":"info"}),await tt(),Z(),o.push("/")}catch(e){e!=="cancel"&&console.error("离开会议失败:",e)}}function Z(){k.cleanup(),I&&(clearInterval(I),I=null)}function me(e){var l,d;const t=e.messageContent;if(t){if(t.meetingMemberList&&t.meetingMemberList.length>0){const O=N.value,j=k.getLocalStream(),W={};Object.keys(g).forEach(a=>{g[a]&&(W[a]=g[a])}),p.value=t.meetingMemberList.map(a=>({...a,videoOpen:a.userId===n.userId?O:a.videoOpen})),Object.keys(W).forEach(a=>{W[a]&&(g[a]=W[a])}),j&&(g[n.userId]=j,le(()=>{b[n.userId]&&(b[n.userId].srcObject=j)}));const ee=p.value.find(a=>a.memberType===se.CREATOR);ee&&(E.value=ee.userId);const te=((l=t.newMember)==null?void 0:l.userId)===n.userId;console.log("=== handleMemberJoin ==="),console.log("My userId:",n.userId),console.log("newMember:",(d=t.newMember)==null?void 0:d.userId),console.log("iAmNewMember:",te),console.log("Total members:",p.value.length),console.log("Current connections:",k.getConnectionCount()),p.value.forEach(a=>{if(a.userId!==n.userId){const K=k.hasConnection(a.userId);console.log(`Checking member ${a.userId}: hasConnection=${K}`),K||(te?(console.log("I am new member, will initiate connection to:",a.userId),setTimeout(()=>{k.hasConnection(a.userId)?console.log("Connection already exists with:",a.userId):(console.log("Initiating delayed connection to:",a.userId),k.initiateConnection(a.userId))},800)):t.newMember&&t.newMember.userId===a.userId?(console.log("New member joined:",a.userId,"- I will also initiate connection"),setTimeout(()=>{k.hasConnection(a.userId)?console.log("Connection already exists with new member:",a.userId):(console.log("Existing member initiating connection to new member:",a.userId),k.initiateConnection(a.userId))},1500)):n.userId>a.userId?(console.log("Fallback: initiating connection to:",a.userId),k.initiateConnection(a.userId)):console.log("Fallback: waiting for connection from:",a.userId))}})}t.newMember&&t.newMember.userId!==n.userId&&y.info(`${t.newMember.nickName} 加入了会议`)}}function he(e){const t=e.messageContent,l=(t==null?void 0:t.exitUserId)||e.sendUserId;if(l){if(l===n.userId){const O=t==null?void 0:t.exitStatus;if(O===Ie.KICK_OUT){y.warning("您已被移出会议"),Z(),o.push("/");return}else if(O===Ie.BLACKLIST){y.error("您已被拉黑，无法重新加入此会议"),Z(),o.push("/");return}return}p.value=p.value.filter(O=>O.userId!==l),k.closeConnection(l),delete g[l];const d=e.sendUserNickName||"成员";y.info(`${d} 离开了会议`)}}function ve(e){const t=e.sendUserId,l=e.messageContent;if(t&&l){const d=p.value.find(O=>O.userId===t);d&&(d.videoOpen=l.videoOpen)}}function pe(e){var t;if(e.sendUserId!==n.userId){const l=((t=e.messageContent)==null?void 0:t.receiveType)||0,d=e.receiveUserId||"0";if(l===1&&d!==n.userId)return;$.value.push({sendUserId:e.sendUserId||"",sendUserNickName:e.sendUserNickName||"",content:e.messageContent,messageContent:e.messageContent,sendTime:e.sendTime||Date.now(),receiveType:l,receiveUserId:d})}}function Ce(e){y.warning("会议已结束"),Z(),o.push("/")}function ze(e,t){console.log("Received remote stream for user:",e,"tracks:",t.getTracks().length),g[e]=t;const l=p.value.find(d=>d.userId===e);l?(l.videoOpen=!0,console.log("Set videoOpen=true for member:",e)):console.warn("Member not found for userId:",e),le(()=>{b[e]?(b[e].srcObject=t,console.log("Set srcObject for user:",e)):(console.log("Video ref not found for user:",e,"will retry..."),setTimeout(()=>{b[e]?(b[e].srcObject=t,console.log("Retry: Set srcObject for user:",e)):console.error("Video ref still not found after retry for user:",e)},500))})}function We(e){delete g[e]}return qe(async()=>{if(i.value=s.params.meetingId,!i.value){y.error("会议ID无效"),o.push("/");return}try{const e=await Ye();e&&(_.value=e.meetingName,u.value=e.meetingNo,E.value=e.createUserId)}catch(e){console.error("获取会议信息失败:",e)}if(k.init(i.value,n.userId,ze,We),await Ae(),p.value=[{userId:n.userId,nickName:n.nickName,joinTime:Date.now(),memberType:se.NORMAL,status:0,videoOpen:N.value,sex:n.sex}],m.on(v.ADD_MEETING_ROOM,me),m.on(v.EXIT_MEETING_ROOM,he),m.on(v.MEETING_USER_VIDEO_CHANGE,ve),m.on(v.CHAT_TEXT_MESSAGE,pe),m.on(v.FINISH_MEETING,Ce),!m.isConnected){console.log("等待 WebSocket 连接就绪...");let e=0;const t=5e3,l=100;for(;!m.isConnected&&e<t;)await new Promise(d=>setTimeout(d,l)),e+=l;if(!m.isConnected){console.error("WebSocket 连接超时"),y.error("连接会议服务器失败，请刷新页面重试");return}}console.log("WebSocket 已连接，复用现有连接"),console.log("Requesting meeting member list via INIT message..."),m.send({messageSendToType:H.GROUP,meetingId:i.value,messageType:v.INIT,sendUserId:n.userId}),I=window.setInterval(()=>{w.value++},1e3),console.log("预加载聊天历史...");try{await ge(),console.log("聊天历史加载完成，消息数量:",$.value.length)}catch(e){console.error("预加载聊天历史失败:",e)}}),Qe(()=>{I&&clearInterval(I),k.cleanup(),m.off(v.ADD_MEETING_ROOM,me),m.off(v.EXIT_MEETING_ROOM,he),m.off(v.MEETING_USER_VIDEO_CHANGE,ve),m.off(v.CHAT_TEXT_MESSAGE,pe),m.off(v.FINISH_MEETING,Ce)}),(e,t)=>{const l=B("el-icon"),d=B("el-button"),O=B("el-drawer"),j=B("el-input"),W=B("el-empty"),ee=B("el-dialog"),te=ft("loading");return f(),T("div",Ut,[r("div",Dt,[r("div",$t,[c(d,{type:"text",class:"back-btn",onClick:xe},{default:h(()=>[c(l,null,{default:h(()=>[c(C(nt))]),_:1}),t[8]||(t[8]=X(" 返回 ",-1))]),_:1}),r("div",Vt,[r("span",Bt,M(_.value),1),r("span",Ht,"会议号: "+M(u.value),1)])]),r("div",Ft,[c(l,null,{default:h(()=>[c(C(ot))]),_:1}),r("span",null,M(Oe(w.value)),1)])]),r("div",zt,[r("div",{class:G(["video-grid",be.value])},[(f(!0),T(re,null,ce(p.value,a=>(f(),T("div",{key:a.userId,class:G(["video-item",{"is-self":a.userId===C(n).userId}])},[a.videoOpen&&ke(a.userId)?(f(),T("video",{key:0,ref_for:!0,ref:K=>Ne(a.userId,K),autoplay:"",playsinline:"",muted:a.userId===C(n).userId},null,8,Wt)):(f(),T("div",Gt,[r("div",Pt,M(a.nickName.charAt(0)),1)])),r("div",jt,[r("span",Kt,M(a.nickName),1),a.videoOpen?D("",!0):(f(),U(l,{key:0,class:"video-off"},{default:h(()=>[c(C(de))]),_:1}))])],2))),128))],2)]),r("div",Xt,[r("div",{class:"control-item",onClick:Le},[c(l,{size:24,class:G({"is-off":!N.value})},{default:h(()=>[N.value?(f(),U(C(_e),{key:0})):(f(),U(C(de),{key:1}))]),_:1},8,["class"]),r("span",null,M(N.value?"关闭视频":"开启视频"),1)]),r("div",{class:"control-item",onClick:Ue},[c(l,{size:24,class:G({"is-off":!L.value})},{default:h(()=>[L.value?(f(),U(C(st),{key:0})):(f(),U(C(at),{key:1}))]),_:1},8,["class"]),r("span",null,M(L.value?"静音":"取消静音"),1)]),r("div",{class:"control-item",onClick:t[0]||(t[0]=a=>q.value=!q.value)},[c(l,{size:24},{default:h(()=>[c(C(it))]),_:1}),r("span",null,"成员 ("+M(p.value.length)+")",1)]),r("div",{class:"control-item",onClick:t[1]||(t[1]=a=>F.value=!0)},[c(l,{size:24},{default:h(()=>[c(C(lt))]),_:1}),t[9]||(t[9]=r("span",null,"邀请",-1))]),r("div",{class:"control-item",onClick:t[2]||(t[2]=a=>J.value=!J.value)},[c(l,{size:24},{default:h(()=>[c(C(rt))]),_:1}),t[10]||(t[10]=r("span",null,"聊天",-1))]),Re.value?(f(),T("div",{key:0,class:"control-item end-meeting",onClick:He},[c(l,{size:24},{default:h(()=>[c(C(ct))]),_:1}),t[11]||(t[11]=r("span",null,"结束会议",-1))])):D("",!0),r("div",{class:"control-item leave",onClick:Fe},[c(l,{size:24},{default:h(()=>[c(C(dt))]),_:1}),t[12]||(t[12]=r("span",null,"离开会议",-1))])]),c(O,{modelValue:q.value,"onUpdate:modelValue":t[3]||(t[3]=a=>q.value=a),title:"会议成员",direction:"rtl",size:"320px"},{default:h(()=>[c(Lt,{members:p.value,"current-user-id":C(n).userId,"creator-id":E.value,onKick:Ve,onBlacklist:Be},null,8,["members","current-user-id","creator-id"])]),_:1},8,["modelValue"]),c(O,{modelValue:J.value,"onUpdate:modelValue":t[4]||(t[4]=a=>J.value=a),title:"会议聊天",direction:"rtl",size:"380px",onOpen:ge},{default:h(()=>[c(St,{messages:$.value,"current-user-id":C(n).userId,loading:V.value,"has-more":z.value,"show-private-select":!0,members:p.value,onSend:De,onLoadMore:$e},null,8,["messages","current-user-id","loading","has-more","members"])]),_:1},8,["modelValue"]),c(ee,{modelValue:F.value,"onUpdate:modelValue":t[7]||(t[7]=a=>F.value=a),title:"邀请联系人",width:"450px","close-on-click-modal":!1},{footer:h(()=>[x.value.length>0?(f(),T("span",tn," 已选择 "+M(x.value.length)+" 人 ",1)):D("",!0),c(d,{onClick:t[6]||(t[6]=a=>F.value=!1)},{default:h(()=>[...t[13]||(t[13]=[X("取消",-1)])]),_:1}),c(d,{type:"primary",loading:ie.value,disabled:x.value.length===0,onClick:Me},{default:h(()=>[...t[14]||(t[14]=[X(" 发送邀请 ",-1)])]),_:1},8,["loading","disabled"])]),default:h(()=>[r("div",qt,[c(j,{modelValue:P.value,"onUpdate:modelValue":t[5]||(t[5]=a=>P.value=a),placeholder:"搜索联系人",clearable:"",class:"invite-search"},{prefix:h(()=>[c(l,null,{default:h(()=>[c(C(gt))]),_:1})]),_:1},8,["modelValue"]),ut((f(),T("div",Jt,[(f(!0),T(re,null,ce(ue.value,a=>(f(),T("div",{key:a.contactId,class:G(["contact-item",{"is-selected":x.value.includes(a.contactId)}]),onClick:K=>Ee(a.contactId)},[r("div",Qt,M(a.contactNickName.charAt(0)),1),r("div",Zt,[r("span",en,M(a.contactNickName),1),r("span",{class:G(["contact-status",{"is-online":a.online}])},M(a.online?"在线":"离线"),3)]),x.value.includes(a.contactId)?(f(),U(l,{key:0,class:"check-icon"},{default:h(()=>[c(C(mt))]),_:1})):D("",!0)],10,Yt))),128)),ue.value.length===0&&!Y.value?(f(),U(W,{key:0,description:"暂无联系人"})):D("",!0)])),[[te,Y.value]])])]),_:1},8,["modelValue"])])}}}),rn=Te(nn,[["__scopeId","data-v-10137a04"]]);export{rn as default};
