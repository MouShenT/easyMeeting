# EasyMeeting 项目升级文档

## 升级概述

本次升级将项目从 Java 8 + Spring Boot 2.7.18 升级到 Java 23 + Spring Boot 3.4.0，以适配本地 JDK 23 环境。

## 版本变更对照表

| 组件 | 升级前 | 升级后 |
|------|--------|--------|
| Java | 1.8 | 23 |
| Spring Boot | 2.7.18 | 3.4.0 |
| Spring Framework | 5.3.31 | 6.2.0 |
| MyBatis Starter | 1.3.2 | 3.0.3 |
| Logback | 1.2.10 | 1.5.12 |
| MySQL Connector | 8.0.23 | 8.0.33 |
| AspectJ | 1.9.4 | 1.9.21 |
| Fastjson | 1.2.66 | 2.0.43 |
| Commons Lang3 | 3.4 | 3.14.0 |
| Commons Codec | 1.9 | 1.16.0 |
| Commons IO | 2.5 | 2.15.1 |
| Netty | 4.1.50 | 4.1.104 |
| Redisson | 3.12.3 | 3.25.2 |
| RabbitMQ Client | 5.14.2 | 5.20.0 |

## 主要修改内容

### 1. pom.xml 修改

```xml
<!-- Spring Boot Parent 版本 -->
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>3.4.0</version>
</parent>

<!-- Java 版本配置 -->
<properties>
    <java.version>23</java.version>
    <maven.compiler.source>23</maven.compiler.source>
    <maven.compiler.target>23</maven.compiler.target>
</properties>
```

### 2. logback-spring.xml 修改

**修改前（已废弃的配置）：**
```xml
<rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
    <TimeBasedFileNamingAndTriggeringPolicy 
        class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
        <MaxFileSize>20MB</MaxFileSize>
    </TimeBasedFileNamingAndTriggeringPolicy>
</rollingPolicy>
```

**修改后（新版配置）：**
```xml
<rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
    <fileNamePattern>...</fileNamePattern>
    <maxFileSize>20MB</maxFileSize>
    <maxHistory>30</maxHistory>
</rollingPolicy>
```

---

## 项目构建注意事项

### 1. Maven 配置要求

- Maven 版本：3.9.x 或更高
- 确保 `JAVA_HOME` 指向 JDK 23
- 构建命令：
  ```bash
  mvn clean compile    # 编译
  mvn clean package    # 打包
  mvn spring-boot:run  # 运行
  ```

### 2. IDE 配置

**IntelliJ IDEA：**
1. File → Project Structure → Project SDK → 选择 JDK 23
2. File → Project Structure → Modules → Language Level → 23
3. 修改 pom.xml 后：右键 pom.xml → Maven → Reload Project
4. 如遇缓存问题：Build → Rebuild Project

### 3. 常见构建问题

**问题1：Unsupported class file major version 67**
- 原因：Spring Boot 版本不支持 JDK 23 编译的 class 文件
- 解决：升级 Spring Boot 到 3.4.0+

**问题2：Maven 本地仓库 pom 文件损坏**
- 现象：`Non-readable POM` 错误
- 解决：删除对应的本地仓库目录，重新下载
  ```bash
  # 示例
  rm -rf ~/.m2/repository/io/micrometer/micrometer-bom/1.14.0
  ```

**问题3：IDE 缓存旧依赖**
- 现象：pom.xml 已修改但运行时仍用旧版本
- 解决：
  1. Maven → Reload Project
  2. mvn clean compile
  3. 必要时删除 target 目录

---

## Logback 配置注意事项

### 1. Spring Boot 3.x 中的 Logback 变化

Spring Boot 3.4.0 默认使用 Logback 1.5.x，该版本有以下重要变化：

| 废弃配置 | 新配置 |
|----------|--------|
| `SizeAndTimeBasedFNATP` | `SizeAndTimeBasedRollingPolicy` |
| `<layout>` 子元素 | `<encoder>` 子元素 |
| `<FileNamePattern>` | `<fileNamePattern>` (小写) |
| `<MaxFileSize>` | `<maxFileSize>` (小写) |

### 2. 推荐的 logback-spring.xml 配置模板

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration scan="true" scanPeriod="10 minutes">
    
    <!-- 控制台输出 -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss} [%p][%c][%M][%L]-> %m%n</pattern>
        </encoder>
    </appender>

    <!-- 文件输出（按大小和时间滚动） -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/app.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/app.%d{yyyyMMdd}.%i.log</fileNamePattern>
            <maxFileSize>20MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>1GB</totalSizeCap>
        </rollingPolicy>
        <encoder>
            <charset>UTF-8</charset>
            <pattern>%d{yyyy-MM-dd HH:mm:ss} [%p][%c][%M][%L]-> %m%n</pattern>
        </encoder>
    </appender>

    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="FILE"/>
    </root>
</configuration>
```

### 3. 使用 Spring Profile 配置日志

```xml
<!-- 开发环境 -->
<springProfile name="dev">
    <root level="DEBUG">
        <appender-ref ref="CONSOLE"/>
    </root>
</springProfile>

<!-- 生产环境 -->
<springProfile name="prod">
    <root level="INFO">
        <appender-ref ref="FILE"/>
    </root>
</springProfile>
```

### 4. 常用日志级别控制

```xml
<!-- 降低框架日志级别 -->
<logger name="org.springframework" level="WARN"/>
<logger name="org.hibernate" level="WARN"/>
<logger name="com.zaxxer.hikari" level="INFO"/>

<!-- 开启 SQL 日志 -->
<logger name="org.mybatis" level="DEBUG"/>
```

---

## Spring Boot 2.x → 3.x 迁移要点

### 1. Jakarta EE 命名空间变更

Spring Boot 3.x 使用 Jakarta EE 9+，包名从 `javax.*` 改为 `jakarta.*`：

```java
// 旧代码
import javax.servlet.http.HttpServletRequest;
import javax.validation.Valid;

// 新代码
import jakarta.servlet.http.HttpServletRequest;
import jakarta.validation.Valid;
```

### 2. 需要检查的常见包

| 旧包名 | 新包名 |
|--------|--------|
| javax.servlet | jakarta.servlet |
| javax.validation | jakarta.validation |
| javax.annotation | jakarta.annotation |
| javax.persistence | jakarta.persistence |

### 3. 配置属性变更

部分配置属性在 Spring Boot 3.x 中有变化，建议查阅官方迁移指南。

---

## 验证升级成功

运行以下命令验证项目正常启动：

```bash
cd easymeeting-java
mvn clean compile
mvn spring-boot:run
```

成功标志：
```
Started EasymeetingApplication in X.XXX seconds
```

---

## 参考资料

- [Spring Boot 3.0 Migration Guide](https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide)
- [Logback Manual](https://logback.qos.ch/manual/)
- [JDK 23 Release Notes](https://openjdk.org/projects/jdk/23/)
